import requests
from dataclasses import dataclass


@dataclass
class MockResult:
    text: str


class Debank:
    chains = "arb,eth"

    def __init__(self, key, mock=False):
        self.key = key
        self.mock = mock

    def _query(self, url):
        headers = {"accept": "application/json", "AccessKey": self.key}
        return requests.get("https://pro-openapi.debank.com" + url, headers=headers)

    def project_list(self, wallet):
        if self.mock:
            return MockResult(
                '''[{""id"": ""arb_uniswap3"", ""chain"": ""arb"", ""name"": ""Uniswap V3"", ""site_url"": ""https://app.uniswap.org"", ""logo_url"": ""https://static.debank.com/image/project/logo_url/arb_uniswap3/87a541b3b83b041c8d12119e5a0d19f0.png"", ""has_supported_portfolio"": true, ""tvl"": 332836736.43751, ""portfolio_item_list"": [{""stats"": {""asset_usd_value"": 119741.18824835768, ""debt_usd_value"": 0, ""net_usd_value"": 119741.18824835768}, ""asset_dict"": {""0x82af49447d8a07e3bd95bd0d56f35241523fbab1"": 27.28004543429266, ""0xff970a61a04b1ca14834a43f5de4533ebddb5cc8"": 68359.20676354966}, ""asset_token_list"": [{""id"": ""0x82af49447d8a07e3bd95bd0d56f35241523fbab1"", ""chain"": ""arb"", ""name"": ""Wrapped Ether"", ""symbol"": ""WETH"", ""display_symbol"": null, ""optimized_symbol"": ""WETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/arb_token/logo_url/0x82af49447d8a07e3bd95bd0d56f35241523fbab1/61844453e63cf81301f845d7864236f6.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1622346702.0, ""amount"": 27.28004543429266}, {""id"": ""0xff970a61a04b1ca14834a43f5de4533ebddb5cc8"", ""chain"": ""arb"", ""name"": ""USD Coin (Arb1)"", ""symbol"": ""USDC"", ""display_symbol"": ""USDC(Bridged)"", ""optimized_symbol"": ""USDC(Bridged)"", ""decimals"": 6, ""logo_url"": ""https://static.debank.com/image/coin/logo_url/usdc/e87790bfe0b3f2ea855dc29069b38818.png"", ""protocol_id"": ""arb_tracer"", ""price"": 1.0001, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1623868379.0, ""amount"": 68359.20676354966}], ""update_at"": 1689236115.0, ""name"": ""Liquidity Pool"", ""detail_types"": [""common""], ""detail"": {""supply_token_list"": [{""id"": ""0x82af49447d8a07e3bd95bd0d56f35241523fbab1"", ""chain"": ""arb"", ""name"": ""Wrapped Ether"", ""symbol"": ""WETH"", ""display_symbol"": null, ""optimized_symbol"": ""WETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/arb_token/logo_url/0x82af49447d8a07e3bd95bd0d56f35241523fbab1/61844453e63cf81301f845d7864236f6.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1622346702.0, ""amount"": 26.296716138698265}, {""id"": ""0xff970a61a04b1ca14834a43f5de4533ebddb5cc8"", ""chain"": ""arb"", ""name"": ""USD Coin (Arb1)"", ""symbol"": ""USDC"", ""display_symbol"": ""USDC(Bridged)"", ""optimized_symbol"": ""USDC(Bridged)"", ""decimals"": 6, ""logo_url"": ""https://static.debank.com/image/coin/logo_url/usdc/e87790bfe0b3f2ea855dc29069b38818.png"", ""protocol_id"": ""arb_tracer"", ""price"": 1.0001, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1623868379.0, ""amount"": 66499.70888654966}], ""reward_token_list"": [{""id"": ""0x82af49447d8a07e3bd95bd0d56f35241523fbab1"", ""chain"": ""arb"", ""name"": ""Wrapped Ether"", ""symbol"": ""WETH"", ""display_symbol"": null, ""optimized_symbol"": ""WETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/arb_token/logo_url/0x82af49447d8a07e3bd95bd0d56f35241523fbab1/61844453e63cf81301f845d7864236f6.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1622346702.0, ""amount"": 0.9833292955943939}, {""id"": ""0xff970a61a04b1ca14834a43f5de4533ebddb5cc8"", ""chain"": ""arb"", ""name"": ""USD Coin (Arb1)"", ""symbol"": ""USDC"", ""display_symbol"": ""USDC(Bridged)"", ""optimized_symbol"": ""USDC(Bridged)"", ""decimals"": 6, ""logo_url"": ""https://static.debank.com/image/coin/logo_url/usdc/e87790bfe0b3f2ea855dc29069b38818.png"", ""protocol_id"": ""arb_tracer"", ""price"": 1.0001, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1623868379.0, ""amount"": 1859.497877}]}, ""proxy_detail"": {}, ""position_index"": ""675906"", ""pool"": {""id"": ""0xc31e54c7a869b9fcbecc14363cf510d1c41fa443"", ""chain"": ""arb"", ""project_id"": ""arb_uniswap3"", ""adapter_id"": ""uniswap3_liquidity"", ""controller"": ""0xc31e54c7a869b9fcbecc14363cf510d1c41fa443"", ""index"": null, ""time_at"": null}}]}, {""id"": ""lido"", ""chain"": ""eth"", ""name"": ""LIDO"", ""site_url"": ""https://stake.lido.fi"", ""logo_url"": ""https://static.debank.com/image/project/logo_url/lido/081388ebc44fa042561749bd5338d49e.png"", ""has_supported_portfolio"": true, ""tvl"": 14371032620.212019, ""portfolio_item_list"": [{""stats"": {""asset_usd_value"": 1.88325e-15, ""debt_usd_value"": 0, ""net_usd_value"": 1.88325e-15}, ""asset_dict"": {""eth"": 1e-18}, ""asset_token_list"": [{""id"": ""eth"", ""chain"": ""eth"", ""name"": ""ETH"", ""symbol"": ""ETH"", ""display_symbol"": null, ""optimized_symbol"": ""ETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/token/logo_url/eth/935ae4e4d1d12d59a99717a24f2540b5.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1483200000.0, ""amount"": 1e-18}], ""update_at"": 1689236115.0, ""name"": ""Staked"", ""detail_types"": [""common""], ""detail"": {""supply_token_list"": [{""id"": ""eth"", ""chain"": ""eth"", ""name"": ""ETH"", ""symbol"": ""ETH"", ""display_symbol"": null, ""optimized_symbol"": ""ETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/token/logo_url/eth/935ae4e4d1d12d59a99717a24f2540b5.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1483200000.0, ""amount"": 1e-18}], ""description"": ""stETH""}, ""proxy_detail"": {}, ""pool"": {""id"": ""0xae7ab96520de3a18e5e111b5eaab095312d7fe84"", ""chain"": ""eth"", ""project_id"": ""lido"", ""adapter_id"": ""lido_staked"", ""controller"": ""0xae7ab96520de3a18e5e111b5eaab095312d7fe84"", ""index"": null, ""time_at"": 1608242396}}]}, {""id"": ""zharta"", ""chain"": ""eth"", ""name"": ""Zharta"", ""site_url"": ""https://app.zharta.io/dashboard/loans"", ""logo_url"": ""https://static.debank.com/image/project/logo_url/zharta/db3bee51f1e0cc095f2924d5f559610c.png"", ""has_supported_portfolio"": true, ""tvl"": 1774312.5868384596, ""portfolio_item_list"": [{""stats"": {""asset_usd_value"": 229525.793315961, ""debt_usd_value"": 0, ""net_usd_value"": 229525.793315961}, ""asset_dict"": {""eth"": 121.87749545517643}, ""asset_token_list"": [{""id"": ""eth"", ""chain"": ""eth"", ""name"": ""ETH"", ""symbol"": ""ETH"", ""display_symbol"": null, ""optimized_symbol"": ""ETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/token/logo_url/eth/935ae4e4d1d12d59a99717a24f2540b5.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1483200000.0, ""amount"": 121.87749545517643}], ""update_at"": 1689236916.0, ""name"": ""Deposit"", ""detail_types"": [""common""], ""detail"": {""supply_token_list"": [{""id"": ""eth"", ""chain"": ""eth"", ""name"": ""ETH"", ""symbol"": ""ETH"", ""display_symbol"": null, ""optimized_symbol"": ""ETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/token/logo_url/eth/935ae4e4d1d12d59a99717a24f2540b5.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1483200000.0, ""amount"": 121.87749545517643}]}, ""proxy_detail"": {}, ""pool"": {""id"": ""0x8d0f9c9fa4c1b265cd5032fe6ba4fefc9d94badb"", ""chain"": ""eth"", ""project_id"": ""zharta"", ""adapter_id"": ""zharta_deposit"", ""controller"": ""0x8d0f9c9fa4c1b265cd5032fe6ba4fefc9d94badb"", ""index"": null, ""time_at"": 1685484047}}]}]'''
            )
        return self._query(
            f"/v1/user/all_complex_protocol_list?id={wallet}&chain_ids={self.chains}"
        )

    def tokens(self, wallet, all=False):
        if self.mock:
            return MockResult(
                '''[{""id"": ""0xff970a61a04b1ca14834a43f5de4533ebddb5cc8"", ""chain"": ""arb"", ""name"": ""USD Coin (Arb1)"", ""symbol"": ""USDC"", ""display_symbol"": ""USDC(Bridged)"", ""optimized_symbol"": ""USDC(Bridged)"", ""decimals"": 6, ""logo_url"": ""https://static.debank.com/image/coin/logo_url/usdc/e87790bfe0b3f2ea855dc29069b38818.png"", ""protocol_id"": ""arb_tracer"", ""price"": 1.0001, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1623868379.0, ""amount"": 199.024436, ""raw_amount"": 199024436, ""raw_amount_hex_str"": ""0xbdcdf34""}, {""id"": ""arb"", ""chain"": ""arb"", ""name"": ""ETH"", ""symbol"": ""ETH"", ""display_symbol"": null, ""optimized_symbol"": ""ETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/arb_token/logo_url/arb/d61441782d4a08a7479d54aea211679e.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1622131200.0, ""amount"": 0.44188306587879955, ""raw_amount"": 441883065878799533, ""raw_amount_hex_str"": ""0x621e24ea5f764ad""}, {""id"": ""0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"", ""chain"": ""eth"", ""name"": ""USD Coin"", ""symbol"": ""USDC"", ""display_symbol"": null, ""optimized_symbol"": ""USDC"", ""decimals"": 6, ""logo_url"": ""https://static.debank.com/image/coin/logo_url/usdc/e87790bfe0b3f2ea855dc29069b38818.png"", ""protocol_id"": """", ""price"": 1.0001, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1533324504.0, ""amount"": 70137.267916, ""raw_amount"": 70137267916, ""raw_amount_hex_str"": ""0x105481c6cc""}, {""id"": ""0xdac17f958d2ee523a2206206994597c13d831ec7"", ""chain"": ""eth"", ""name"": ""Tether USD"", ""symbol"": ""USDT"", ""display_symbol"": """", ""optimized_symbol"": ""USDT"", ""decimals"": 6, ""logo_url"": ""https://static.debank.com/image/coin/logo_url/usdt/23af7472292cb41dc39b3f1146ead0fe.png"", ""protocol_id"": """", ""price"": 0.999925, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1511829681.0, ""amount"": 0.061205, ""raw_amount"": 61205, ""raw_amount_hex_str"": ""0xef15""}, {""id"": ""eth"", ""chain"": ""eth"", ""name"": ""ETH"", ""symbol"": ""ETH"", ""display_symbol"": null, ""optimized_symbol"": ""ETH"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/token/logo_url/eth/935ae4e4d1d12d59a99717a24f2540b5.png"", ""protocol_id"": """", ""price"": 1883.25, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1483200000.0, ""amount"": 20.18512648502253, ""raw_amount"": 20185126485022528379, ""raw_amount_hex_str"": ""0x1181ff997be18d37b""}, {""id"": ""0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"", ""chain"": ""pls"", ""name"": ""USD Coin"", ""symbol"": ""USDC"", ""display_symbol"": ""USDC(fork)"", ""optimized_symbol"": ""USDC(fork)"", ""decimals"": 6, ""logo_url"": null, ""protocol_id"": """", ""price"": 6.114810460040615e-05, ""is_verified"": false, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1533324504.0, ""amount"": 100338.267916, ""raw_amount"": 100338267916, ""raw_amount_hex_str"": ""0x175ca0770c""}, {""id"": ""0xdac17f958d2ee523a2206206994597c13d831ec7"", ""chain"": ""pls"", ""name"": ""Tether USD"", ""symbol"": ""USDT"", ""display_symbol"": ""USDT(fork)"", ""optimized_symbol"": ""USDT(fork)"", ""decimals"": 6, ""logo_url"": null, ""protocol_id"": """", ""price"": 5.706013986742865e-05, ""is_verified"": false, ""is_core"": true, ""is_wallet"": true, ""time_at"": 1511829681.0, ""amount"": 0.061205, ""raw_amount"": 61205, ""raw_amount_hex_str"": ""0xef15""}, {""id"": ""pls"", ""chain"": ""pls"", ""name"": ""PLS"", ""symbol"": ""PLS"", ""display_symbol"": null, ""optimized_symbol"": ""PLS"", ""decimals"": 18, ""logo_url"": ""https://static.debank.com/image/pls_token/logo_url/pls/aa6be079fa9eb568e02150734ebb3db0.png"", ""protocol_id"": """", ""price"": 0.0001091, ""is_verified"": true, ""is_core"": true, ""is_wallet"": true, ""time_at"": null, ""amount"": 30.41837426591651, ""raw_amount"": 30418374265916509673, ""raw_amount_hex_str"": ""0x1a623c63b3cd64de9""}]'''
            )
        is_all = "true" if all else "false"
        return self._query(
            f"/v1/user/all_token_list?id={wallet}&is_all={is_all}&chain_ids={self.chains}"
        )

    def total_value(self, wallet):
        if self.mock:

            class Res:
                def json(self):
                    return {"total_usd_value": 555}

            return Res()
        return self._query(
            f"/v1/user/total_balance?id={wallet}&chain_ids={self.chains}"
        )
